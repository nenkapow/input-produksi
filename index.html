<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App Produksi Supabase - v0.7.0</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* --- STYLE SAMA PERSIS v0.6.5 --- */
:root { --bg-body:#f1f5f9; --bg-card:#ffffff; --text-main:#0f172a; --text-muted:#64748b; --border:#e2e8f0; --primary:#4f46e5; --primary-hover:#4338ca; --success:#10b981; --danger:#ef4444; --warning:#f59e0b; --radius:12px; }
* { box-sizing:border-box; outline:none; }
body { margin:0; background:var(--bg-body); color:var(--text-main); font-family:'Inter',sans-serif; }
.wrap { max-width:1400px; margin:0 auto; padding:2rem; }
.row { display:flex; gap:12px; flex-wrap:wrap; }
.grid { display:grid; gap:16px; }
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:16px; box-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05); }
.btn { display:inline-flex; align-items:center; justify-content:center; padding:10px 18px; font-size:0.9rem; font-weight:500; border-radius:8px; border:1px solid var(--border); background:white; color:var(--text-main); cursor:pointer; transition:0.2s; }
.btn:hover { background:#f8fafc; }
.btn.primary { background:var(--primary); color:white; border-color:var(--primary); }
.btn.ok { background:var(--success); color:white; border-color:var(--success); }
.btn.danger { background:white; color:var(--danger); border-color:#fecaca; }
.btn.danger:hover { background:#fef2f2; }
.btn.sm { padding:6px 12px; font-size:0.8rem; border-radius:6px; }
.input, select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#f8fafc; }
.input:focus { background:white; border-color:var(--primary); }
table { width:100%; border-collapse:separate; border-spacing:0; font-size:0.85rem; }
thead th { background:#f8fafc; color:var(--text-muted); padding:12px 8px; border-bottom:1px solid var(--border); text-align:left; position:sticky; top:0; white-space:nowrap; }
tbody td { padding:8px; border-bottom:1px solid var(--border); vertical-align:middle; }
.right { text-align:right; font-family:'JetBrains Mono',monospace; }
.badge { font-size:0.75rem; padding:4px 10px; border-radius:20px; background:#e0e7ff; color:var(--primary); border:1px solid #c7d2fe; }
.modal { position:fixed; inset:0; background:rgba(15,23,42,0.6); backdrop-filter:blur(4px); display:none; align-items:flex-start; justify-content:center; padding:40px 20px; z-index:100; overflow:auto; }
.modal.open { display:flex; }
.modal .card { width:100%; max-width:1100px; animation: slideUp 0.3s; }
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:200; display:none; align-items:center; justify-content:center; flex-direction:column; }
.spinner { width:40px; height:40px; border:4px solid #e2e8f0; border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.muted { color:var(--text-muted); font-size:0.85rem; margin-bottom:4px; }
.stat-box { background:#f8fafc; border:1px solid var(--border); border-radius:8px; padding:12px; text-align:center; }
@media (max-width:768px) { .wrap{padding:1rem} .grid{grid-template-columns:1fr!important} .filter-bar>div{flex:1 1 100%} }
</style>
</head>
<body>

<div id="loading" class="loading-overlay">
  <div class="spinner"></div>
  <div style="margin-top:10px; font-weight:600; color:var(--text-main);">Koneksi Supabase...</div>
</div>

<div class="wrap">
  <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:24px;">
    <div>
      <h2>App Produksi Supabase <span style="font-weight:400; color:var(--text-muted); font-size:1rem;">v0.7.0 (Fast)</span></h2>
      <div class="muted" style="margin-top:4px;">Database: Supabase (Real-time DB)</div>
    </div>
    <div class="row">
      <button id="btnRefresh" class="btn">üîÑ Refresh Data</button>
      <button id="btnPrint" class="btn ok">Cetak</button>
    </div>
  </div>

  <div class="card" style="padding:16px;">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div class="row">
        <button id="btnAdd" class="btn primary" style="font-weight:600">+ Input Produksi</button>
        <button id="btnMaster" class="btn">Master Produk</button>
        <button id="btnExport" class="btn ok">Export CSV</button>
      </div>
      <button id="btnClear" class="btn danger" style="margin-left:auto">Hapus Data Laporan</button>
    </div>
  </div>

  <div class="card">
    <h4 style="color:var(--text-main); font-size:0.9rem; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:12px;">Filter Data</h4>
    <div class="row" style="align-items:flex-end;">
      <div style="flex:1; min-width:140px"><div class="muted">Dari Tanggal</div><input id="fFrom" type="date" class="input"></div>
      <div style="flex:1; min-width:140px"><div class="muted">Sampai Tanggal</div><input id="fTo" type="date" class="input"></div>
      <div style="flex:2; min-width:200px"><div class="muted">Cari Produk</div><input id="fProduk" class="input" placeholder="Nama / Kode..." /></div>
      <div style="flex:1; min-width:100px"><div class="muted">Shift</div><select id="fShift" class="input"><option value="">Semua</option><option>1</option><option>2</option><option>3</option></select></div>
      <div style="flex:1; min-width:120px"><div class="muted">Line/Mesin</div><input id="fLine" class="input" placeholder="Cth: L-01" /></div>
      <div style="padding-bottom:1px;"><button id="btnClearFilter" class="btn">Reset</button></div>
    </div>
  </div>

  <div class="card" style="overflow:hidden; padding:0;">
    <div style="padding:16px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
      <h3 style="font-size:1rem;">Laporan Produksi</h3>
      <span id="rowCount" class="badge" style="background:white; border:1px solid var(--border); color:var(--text-muted);">0 data</span>
    </div>
    <div style="overflow:auto; max-height:65vh;">
      <table>
        <thead>
          <tr>
            <th>Tanggal</th><th>Shift</th><th>Line</th><th>Produk</th><th>Tipe</th>
            <th class="right">Counter</th><th class="right">Cavity</th>
            <th class="right">Dus</th><th class="right">Box</th>
            <th class="right">OK (pcs)</th><th class="right">OK (kg)</th>
            <th class="right">Reject</th><th class="right">Sisa Bahan</th>
            <th class="right">Yield %</th><th class="right">R. Max</th>
            <th style="text-align:center">Aksi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="mMaster" class="modal"><div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px;">
      <h3>Master Produk</h3>
      <div class="row">
        <label style="display:flex; align-items:center; gap:6px; font-size:0.85rem; background:#f1f5f9; padding:6px 10px; border-radius:6px; cursor:pointer;">
            <input type="checkbox" id="chkAllowDup" /> Allow Dup
        </label>
        <button id="btnImportCsv" class="btn ok sm">Import CSV</button>
        <button id="mMasterClose" class="btn sm">Tutup</button>
        <input type="file" id="fileCsvMaster" accept=".csv" style="display:none;" />
      </div>
    </div>
    <div style="background:var(--bg-body); padding:20px; border-radius:var(--radius); margin-bottom:24px;">
      <h4 style="font-size:0.85rem; margin-bottom:12px;">Tambah / Edit Manual</h4>
      <div class="grid" style="grid-template-columns:repeat(12,1fr)">
        <div style="grid-column:span 2"><div class="muted">Kode</div><input id="mpKode" class="input" placeholder="Kode" /></div>
        <div style="grid-column:span 4"><div class="muted">Nama</div><input id="mpNama" class="input" placeholder="Nama Produk" /></div>
        <div style="grid-column:span 2"><div class="muted">Tipe</div><select id="mpTipe" class="input"><option value="pcs">pcs</option><option value="kg_sisa">kg</option></select></div>
        <div style="grid-column:span 2"><div class="muted">Gram</div><input id="mpGram" class="input" placeholder="0.00" type="number" step="0.01" /></div>
        <div style="grid-column:span 2"><div class="muted">Runner</div><input id="mpRunner" class="input" placeholder="0.00" type="number" step="0.01" /></div>
        <div style="grid-column:span 2"><div class="muted">Cavity</div><input id="mpCavity" class="input" placeholder="1" type="number" /></div>
        <div style="grid-column:span 2"><div class="muted">Isi Dus</div><input id="mpPerDus" class="input" placeholder="0" type="number" /></div>
        <div style="grid-column:span 2"><div class="muted">Isi Box</div><input id="mpPerBox" class="input" placeholder="0" type="number" /></div>
        <div style="grid-column:span 6"><div class="muted">&nbsp;</div><button id="mpAdd" class="btn primary" style="width:100%">+ Simpan / Update</button></div>
      </div>
    </div>
    <div style="overflow:auto; max-height:50vh; border:1px solid var(--border);">
      <table><thead><tr><th>Kode</th><th>Nama</th><th>Tipe</th><th class="right">Gram</th><th class="right">Runner</th><th class="right">Cav</th><th class="right">Dus</th><th style="text-align:center">Aksi</th></tr></thead><tbody id="mpBody"></tbody></table>
    </div>
</div></div>

<div id="mEntry" class="modal">
  <div class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:16px; border-bottom:1px solid var(--border); padding-bottom:16px;">
      <div style="display:flex; align-items:center; gap:12px;"><h3>Input Produksi <span id="badgeTipe" class="badge"></span></h3></div>
      <button id="mEntryClose" class="btn sm">Tutup ‚úï</button>
    </div>
    <div class="grid" style="grid-template-columns:repeat(12,1fr)">
      <div style="grid-column:span 3"><div class="muted">Tanggal</div><input id="eTanggal" type="date" class="input" /></div>
      <div style="grid-column:span 2"><div class="muted">Shift</div><select id="eShift" class="input"><option>1</option><option>2</option><option>3</option></select></div>
      <div style="grid-column:span 3"><div class="muted">Line</div><input id="eLine" class="input" placeholder="Line" /></div>
      <div style="grid-column:span 4"><div class="muted">Produk</div><input id="eProduk" class="input" placeholder="Cari..." list="produkList" /></div>
      <datalist id="produkList"></datalist>
      <div style="grid-column:span 12; border-top:1px dashed var(--border); margin-top:8px;"></div>
      <div style="grid-column:span 2"><div class="muted">Gram</div><input id="eGram" type="number" class="input" step="0.01" readonly style="background:#e2e8f0" /></div>
      <div style="grid-column:span 2"><div class="muted">Runner</div><input id="eRunner" type="number" class="input" step="0.01" readonly style="background:#e2e8f0" /></div>
      <div style="grid-column:span 2"><div class="muted">Cavity</div><input id="eCavity" type="number" class="input" /></div>
      <div style="grid-column:span 6"><div class="muted">Counter (Shot)</div><input id="eCounter" type="number" class="input" /></div>
      
      <div style="grid-column:span 12" class="card" style="background:#f8fafc; padding:16px;">
        <h4 style="margin:0 0 12px; font-size:0.9rem;">Bahan (kg)</h4>
        <div class="grid" style="grid-template-columns:repeat(8,1fr)">
          <div style="grid-column:span 2"><div class="muted">Jatah</div><input id="eJatah" type="number" step="0.01" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Stok</div><input id="eStok" type="number" step="0.01" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Balokan</div><input id="eBalokan" type="number" step="0.01" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Sisa</div><input id="eSisaBahan" type="number" readonly class="input" style="background:#e2e8f0; font-weight:bold;" /></div>
        </div>
      </div>

      <div style="grid-column:span 6; border-right:1px solid var(--border); padding-right:10px">
        <div class="muted"><b>Sisa Sebelum</b></div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr); gap:8px;">
          <input id="eSblm1" class="input" type="number" step="0.01" placeholder="C1" /> <input id="eSblm2" class="input" type="number" step="0.01" /> <input id="eSblm3" class="input" type="number" step="0.01" />
          <input id="eSblm4" class="input" type="number" step="0.01" /> <input id="eSblm5" class="input" type="number" step="0.01" /> <input id="eSblm6" class="input" type="number" step="0.01" />
        </div>
      </div>
      <div style="grid-column:span 6; padding-left:10px">
        <div class="muted"><b>Sisa Sesudah</b></div>
        <div class="grid" style="grid-template-columns:repeat(3,1fr); gap:8px;">
          <input id="eSsdh1" class="input" type="number" step="0.01" placeholder="C1" /> <input id="eSsdh2" class="input" type="number" step="0.01" /> <input id="eSsdh3" class="input" type="number" step="0.01" />
          <input id="eSsdh4" class="input" type="number" step="0.01" /> <input id="eSsdh5" class="input" type="number" step="0.01" /> <input id="eSsdh6" class="input" type="number" step="0.01" />
        </div>
      </div>

      <div style="grid-column:span 12; margin:8px 0; border-bottom:1px solid var(--border)"></div>

      <div style="grid-column:span 12">
        <h4 style="margin:0 0 12px; font-size:0.9rem;">Packaging</h4>
        <div class="grid" style="grid-template-columns:repeat(12,1fr)">
          <div style="grid-column:span 2"><div class="muted">Dus</div><input id="eQtyDus" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Isi/D</div><input id="eIsiDus" type="number" class="input" readonly style="background:#e2e8f0" /></div>
          <div style="grid-column:span 2"><div class="muted">Box</div><input id="eQtyBox" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Isi/B</div><input id="eIsiBox" type="number" class="input" readonly style="background:#e2e8f0" /></div>
          <div style="grid-column:span 2"><div class="muted">Dus+</div><input id="eQtyDusPlus" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Isi+</div><input id="eIsiDusPlus" type="number" class="input" /></div>
          <div style="grid-column:span 12"><div class="muted">Catatan</div><input id="eCatatan" class="input" /></div>
        </div>
      </div>

      <div style="grid-column:span 12" class="card" style="background:#fff1f2; padding:16px;">
        <h4 style="margin:0 0 12px; color:var(--danger); font-size:0.9rem;">Reject (Pcs)</h4>
        <div class="grid" style="grid-template-columns:repeat(10,1fr)">
          <div style="grid-column:span 2"><div class="muted">Bintik</div><input id="rBintik" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Flash</div><input id="rFlashing" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Short</div><input id="rShort" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Warna</div><input id="rWarna" type="number" class="input" /></div>
          <div style="grid-column:span 2"><div class="muted">Lain</div><input id="rLain" type="number" class="input" /></div>
          <input id="rTotal" type="hidden" /> <input id="rMax" type="hidden" />
        </div>
      </div>

      <div style="grid-column:span 12" class="card" style="background:#f0fdf4; padding:20px; margin-bottom:0;">
        <div class="grid" style="grid-template-columns:repeat(4,1fr); text-align:center;">
          <div><div class="muted">Hasil</div><b id="vHasil" style="font-size:1.2rem; color:var(--primary)">0</b></div>
          <div><div class="muted">OK</div><b id="vOkPcs" style="font-size:1.2rem; color:var(--success)">0</b></div>
          <div><div class="muted">Reject</div><b id="vRejectPcs" style="font-size:1.2rem; color:var(--danger)">0</b></div>
          <div><div class="muted">Yield</div><b id="vYield" style="font-size:1.2rem">0%</b></div>
        </div>
        <div id="warnOver" style="color:var(--danger); background:#fee2e2; padding:8px; border-radius:6px; margin-top:12px; font-weight:600; display:none; text-align:center;">‚ö†Ô∏è Packaging > Hasil Produksi</div>
        <button id="btnSaveEntry" class="btn primary" style="width:100%; margin-top:20px; padding:12px;">SIMPAN DATA</button>
      </div>
    </div>
  </div>
</div>

<script>
// ==========================================
// KONFIGURASI SUPABASE (WAJIB DIISI)
// ==========================================
const SUPABASE_URL = "ISI_URL_SUPABASE_DISINI"; 
const SUPABASE_KEY = "ISI_ANON_KEY_SUPABASE_DISINI";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = id => document.getElementById(id);
const toNum = v => isNaN(+v) ? 0 : +v;
const uid = () => Math.random().toString(36).slice(2);
const todayISO = () => new Date().toISOString().slice(0, 10);

let logs = [];
let master = [];

// --- FETCH DATA (SUPABASE) ---
async function refreshData() {
    $('loading').style.display = 'flex';
    
    // 1. Get Master
    const { data: mData, error: mErr } = await client.from('master').select('*');
    if(mErr) { alert('Error Master: ' + mErr.message); return $('loading').style.display='none'; }
    master = mData || [];

    // 2. Get Logs
    const { data: lData, error: lErr } = await client.from('logs').select('*');
    if(lErr) { alert('Error Logs: ' + lErr.message); return $('loading').style.display='none'; }
    logs = lData || [];

    renderTable();
    renderMaster();
    seedProdukList();
    $('loading').style.display = 'none';
}

// RESET FORM
function resetEntryForm() {
    const fields = [
        'eLine', 'eProduk', 'eGram', 'eRunner', 'eCavity', 'eCounter',
        'eJatah', 'eStok', 'eBalokan', 'eSisaBahan',
        'eSblm1', 'eSblm2', 'eSblm3', 'eSblm4', 'eSblm5', 'eSblm6',
        'eSsdh1', 'eSsdh2', 'eSsdh3', 'eSsdh4', 'eSsdh5', 'eSsdh6',
        'eQtyDus', 'eIsiDus', 'eQtyBox', 'eIsiBox', 'eQtyDusPlus', 'eIsiDusPlus', 'eCatatan',
        'rBintik', 'rFlashing', 'rShort', 'rWarna', 'rLain', 'rTotal', 'rMax'
    ];
    fields.forEach(id => { if($(id)) $(id).value = ''; });
    $('eShift').value = '1';
    $('eTanggal').value = todayISO();
    $('vHasil').innerText = '0'; $('vOkPcs').innerText = '0'; $('vRejectPcs').innerText = '0'; $('vYield').innerText = '0%';
    $('badgeTipe').innerText = ''; $('warnOver').style.display = 'none';
}

// --- CALCULATION LOGIC ---
const sblmIds=['eSblm1','eSblm2','eSblm3','eSblm4','eSblm5','eSblm6'];
const ssdhIds=['eSsdh1','eSsdh2','eSsdh3','eSsdh4','eSsdh5','eSsdh6'];
const rejectIds=['rBintik','rFlashing','rShort','rWarna','rLain'];
function sum(ids){ return ids.map(id=>toNum($(id).value)).reduce((a,b)=>a+b,0); }

function compute(){
    const prodNameFull = $('eProduk').value;
    const prod = master.find(p => p.kode + " ‚Äî " + p.nama === prodNameFull);
    
    const gram = toNum($('eGram').value);
    const tipe = $('badgeTipe').innerText.includes('KG') ? 'kg_sisa' : 'pcs';
    const cav = Math.max(1, toNum($('eCavity').value));
    const counter = toNum($('eCounter').value);
    
    let sblm_disp = sum(sblmIds), ssdh_disp = sum(ssdhIds);
    let sblm_pcs = sblm_disp, ssdh_pcs = ssdh_disp;
    if(tipe === 'kg_sisa'){
        const conv = gram > 0 ? (1000/gram) : 0;
        sblm_pcs = sblm_disp * conv; ssdh_pcs = ssdh_disp * conv;
    }

    const qtyDus = toNum($('eQtyDus').value), isiDus = toNum($('eIsiDus').value);
    const qtyBox = toNum($('eQtyBox').value), isiBox = toNum($('eIsiBox').value);
    const qtyDusPlus = toNum($('eQtyDusPlus').value), isiDusPlus = toNum($('eIsiDusPlus').value);
    const packpcs = (qtyDus*isiDus) + (qtyBox*isiBox) + (qtyDusPlus*isiDusPlus);

    const okpcs = packpcs - sblm_pcs + ssdh_pcs;
    const produksi = counter * cav;
    const hasil = produksi + sblm_pcs - ssdh_pcs;
    const rejectpcs = produksi - okpcs;

    const okkg = (okpcs * gram) / 1000;
    const rejectkg = (rejectpcs * gram) / 1000;
    const runnerkg = (counter * toNum($('eRunner').value)) / 1000;

    const jatah = toNum($('eJatah').value);
    const stok = toNum($('eStok').value);
    const balok = toNum($('eBalokan').value);
    const sisaBahan = (jatah + stok) - (runnerkg + rejectkg + okkg + balok);

    const yieldpct = hasil > 0 ? (okpcs / hasil) * 100 : 0;
    const overpack = packpcs > hasil;
    
    let rTotalInput = sum(rejectIds);
    let rMax = Math.max(...rejectIds.map(id=>toNum($(id).value)));
    $('rTotal').value = rTotalInput; $('rMax').value = rMax;

    return { prod, tipe, gram, cav, counter, sblm_pcs, ssdh_pcs, hasil, okpcs, okkg, rejectpcs, rejectkg, runnerkg, yieldpct, sisaBahan, overpack, packpcs };
}

function recalc(){
    const p = compute();
    $('vHasil').innerText = p.hasil.toFixed(0);
    $('vOkPcs').innerText = p.okpcs.toFixed(0);
    $('vRejectPcs').innerText = p.rejectpcs.toFixed(0);
    $('eSisaBahan').value = p.sisaBahan.toFixed(2); 
    $('vYield').innerText = p.yieldpct.toFixed(2) + "%";
    $('warnOver').style.display = p.overpack ? 'block' : 'none';
}

const calcInputs = ['eProduk','eCavity','eCounter','eRunner','eJatah','eStok','eBalokan', 'eQtyDus','eQtyBox','eQtyDusPlus','eIsiDusPlus', ...sblmIds, ...ssdhIds, ...rejectIds];
calcInputs.forEach(id => { const el = $(id); if(el) el.oninput = () => { if(id === 'eProduk') hydrateProduk(); recalc(); }; });

function hydrateProduk(){
    const val = $('eProduk').value;
    const p = master.find(x => x.kode + " ‚Äî " + x.nama === val);
    if(p) {
        $('eGram').value = p.gram; $('eRunner').value = p.runner; $('eCavity').value = p.cavity;
        $('eIsiDus').value = p.per_dus; $('eIsiBox').value = p.per_box;
        $('badgeTipe').innerText = (p.tipe === 'kg_sisa') ? 'Mode KG' : 'Mode PCS';
        recalc();
    }
}

// SAVE LOG (SUPABASE)
$('btnSaveEntry').onclick = async () => {
    const p = compute();
    if(!p.prod) return alert("Pilih produk valid");
    
    $('loading').style.display='flex';
    const { error } = await client.from('logs').insert({
        id: uid(),
        tanggal: $('eTanggal').value, shift: $('eShift').value, line: $('eLine').value,
        kode: p.prod.kode, nama: p.prod.nama, tipe: p.tipe,
        gram: p.gram, runner: toNum($('eRunner').value), cavity: p.cav, counter: p.counter,
        sisa_sblm: p.sblm_pcs, sisa_ssdh: p.ssdh_pcs, 
        hasil: p.hasil, okpcs: p.okpcs, okkg: p.okkg,
        reject: p.rejectpcs, rejectkg: p.rejectkg, runnerkg: p.runnerkg, 
        sisa_bahan: p.sisaBahan, yieldpct: p.yieldpct,
        qty_dus: toNum($('eQtyDus').value), isi_dus: toNum($('eIsiDus').value),
        qty_box: toNum($('eQtyBox').value), isi_box: toNum($('eIsiBox').value),
        qty_dus_plus: toNum($('eQtyDusPlus').value), isi_dus_plus: toNum($('eIsiDusPlus').value),
        catatan: $('eCatatan').value,
        reject_bintik: toNum($('rBintik').value), reject_flashing: toNum($('rFlashing').value),
        reject_short: toNum($('rShort').value), reject_warna: toNum($('rWarna').value), reject_lain: toNum($('rLain').value), 
        reject_total_kecil: toNum($('rTotal').value), reject_max: toNum($('rMax').value)
    });
    $('loading').style.display='none';

    if(error) alert('Error Save: ' + error.message);
    else { alert('‚úÖ Tersimpan!'); resetEntryForm(); refreshData(); }
};

// MASTER (CRUD SUPABASE)
$('mpAdd').onclick = async () => {
    const kode=$('mpKode').value.trim();
    if(!kode) return alert("Isi Kode");
    
    // Check Dup
    const allow = $('chkAllowDup').checked;
    if(!allow) {
        const exist = master.find(m => m.kode.toLowerCase() === kode.toLowerCase());
        if(exist && !confirm("Kode sudah ada. Update?")) return;
    }

    $('loading').style.display='flex';
    const rec = {
        kode: kode, nama: $('mpNama').value, tipe: $('mpTipe').value,
        gram: toNum($('mpGram').value), runner: toNum($('mpRunner').value),
        cavity: toNum($('mpCavity').value), per_dus: toNum($('mpPerDus').value), per_box: toNum($('mpPerBox').value)
    };
    
    // Upsert (Insert or Update based on ID if exists, but we use Code as key logically here, Supabase uses PK)
    // Utk simpel, kita insert baru atau update by Kode logic manual
    // Better: Upsert by 'id' if editing, or Insert if new.
    // For now: Always Insert New ID (Simple) or if you want update, logic needs ID. 
    // Let's keep it simple: Add New / Replace.
    
    const { error } = await client.from('master').upsert({ id: uid(), ...rec });
    $('loading').style.display='none';
    
    if(error) alert(error.message);
    else { 
        refreshData(); 
        ['mpKode','mpNama','mpGram','mpRunner','mpCavity','mpPerDus','mpPerBox'].forEach(id=>$(id).value=''); 
    }
};

window.deleteLog = async (id) => {
    if(!confirm("Hapus?")) return;
    $('loading').style.display='flex';
    const { error } = await client.from('logs').delete().eq('id', id);
    $('loading').style.display='none';
    if(!error) refreshData();
};

window.deleteMaster = async (id) => { // Supabase butuh ID
    if(!confirm("Hapus Master?")) return;
    $('loading').style.display='flex';
    const { error } = await client.from('master').delete().eq('id', id);
    $('loading').style.display='none';
    if(!error) refreshData();
};

window.editMaster = (idx) => {
    const p = master[idx];
    $('mpKode').value = p.kode; $('mpNama').value = p.nama; $('mpTipe').value = p.tipe;
    $('mpGram').value = p.gram; $('mpRunner').value = p.runner; $('mpCavity').value = p.cavity;
    $('mpPerDus').value = p.per_dus; $('mpPerBox').value = p.per_box;
    // Note: Utk update beneran di Supabase butuh ID. Di versi simple ini, user 'Add' lagi akan jadi row baru/dup.
    // Fitur edit real-time butuh nyimpen ID di tombol update. 
    // Quick fix: Delete old, Insert new (User manual) or Advanced logic.
};

function renderMaster() {
    const t = $('mpBody'); t.innerHTML = '';
    master.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.kode}</td><td>${p.nama}</td><td>${p.tipe}</td>
            <td class="right">${p.gram}</td><td class="right">${p.runner}</td>
            <td class="right">${p.cavity}</td><td class="right">${p.per_dus}</td>
            <td style="text-align:center">
                <button class="btn sm" onclick="editMaster(${idx})">‚úèÔ∏è</button>
                <button class="btn sm danger" onclick="deleteMaster('${p.id}')">üóëÔ∏è</button>
            </td>
        `;
        t.appendChild(tr);
    });
}

function renderTable() {
    const t = $('tbody'); t.innerHTML = '';
    const qFrom = $('fFrom').value, qTo = $('fTo').value;
    const from = qFrom ? new Date(qFrom) : null;
    const to = qTo ? new Date(qTo) : null;
    const qProd = $('fProduk').value.toLowerCase();

    const filtered = logs.filter(r => {
        const d = new Date(r.tanggal);
        return (from ? d >= from : true) && (to ? d <= to : true) && (qProd ? r.nama.toLowerCase().includes(qProd) : true);
    });
    
    $('rowCount').textContent = filtered.length + " data";
    filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${r.tanggal}</td><td>${r.shift}</td><td>${r.line}</td>
            <td><b>${r.nama}</b><br><small>${r.kode}</small></td><td>${r.tipe}</td>
            <td class="right">${r.counter}</td><td class="right">${r.cavity}</td>
            <td class="right">${r.qty_dus}</td><td class="right">${r.qty_box}</td>
            <td class="right text-ok"><b>${(+r.okpcs).toFixed(0)}</b></td><td class="right">${(+r.okkg).toFixed(2)}</td>
            <td class="right text-danger">${(+r.reject).toFixed(0)}</td><td class="right">${(+r.rejectkg).toFixed(2)}</td>
            <td class="right">${(+r.sisa_bahan).toFixed(2)}</td>
            <td class="right"><b>${(+r.yieldpct).toFixed(2)}%</b></td>
            <td class="right">${r.reject_max}</td>
            <td style="text-align:center"><button class="btn sm danger" onclick="deleteLog('${r.id}')">Hapus</button></td>
        `;
        t.appendChild(tr);
    });
}

function seedProdukList() {
    const l = $('produkList'); l.innerHTML = '';
    master.forEach(p => { const opt = document.createElement('option'); opt.value = p.kode + " ‚Äî " + p.nama; l.appendChild(opt); });
}

// IMPORT CSV (SUPABASE)
$('btnImportCsv').onclick = () => $('fileCsvMaster').click();
$('fileCsvMaster').onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (evt) => {
        const text = evt.target.result;
        const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
        if(lines.length < 2) return alert('CSV Salah');
        const delim = lines[0].split(';').length > lines[0].split(',').length ? ';' : ',';
        const headers = lines[0].toLowerCase().split(delim).map(h=>h.trim().replace(/"/g,''));
        
        // Mapping
        const idx = {
            kode: headers.findIndex(h=> h.includes('kode') || h.includes('code')),
            nama: headers.findIndex(h=> h.includes('nama') || h.includes('name')),
            gram: headers.findIndex(h=> h.includes('gram')),
            runner: headers.findIndex(h=> h.includes('runner')),
            cavity: headers.findIndex(h=> h.includes('cav')),
            dus: headers.findIndex(h=> h.includes('dus')),
            box: headers.findIndex(h=> h.includes('box')),
            tipe: headers.findIndex(h=> h.includes('tipe'))
        };
        if(idx.kode < 0) return alert('Header Kode tidak ketemu');

        $('loading').style.display='flex';
        let rows = [];
        for(let i=1; i<lines.length; i++){
            const cols = lines[i].split(delim).map(c=>c.trim().replace(/"/g,''));
            if(cols.length<2) continue;
            rows.push({
                id: uid(),
                kode: cols[idx.kode],
                nama: cols[idx.nama] || cols[idx.kode],
                tipe: idx.tipe>=0 ? cols[idx.tipe] : 'pcs',
                gram: idx.gram>=0 ? toNum(cols[idx.gram].replace(',','.')) : 0,
                runner: idx.runner>=0 ? toNum(cols[idx.runner].replace(',','.')) : 0,
                cavity: idx.cavity>=0 ? toNum(cols[idx.cavity].replace(',','.')) : 1,
                per_dus: idx.dus>=0 ? toNum(cols[idx.dus].replace(',','.')) : 0,
                per_box: idx.box>=0 ? toNum(cols[idx.box].replace(',','.')) : 0
            });
        }
        
        const { error } = await client.from('master').insert(rows);
        $('loading').style.display='none';
        if(error) alert('Error Import: '+error.message);
        else { alert('Import Sukses!'); refreshData(); }
        $('fileCsvMaster').value='';
    };
    reader.readAsText(file);
};

// EXPORT CSV
$('btnExport').onclick = () => {
    const qFrom = $('fFrom').value; const qTo = $('fTo').value;
    const from = qFrom ? new Date(qFrom) : null; const to = qTo ? new Date(qTo) : null;
    const filtered = logs.filter(r => {
        const d = new Date(r.tanggal);
        return (from ? d >= from : true) && (to ? d <= to : true);
    });
    if(filtered.length === 0) return alert("Data kosong");
    const header = Object.keys(filtered[0]).join(",");
    const csv = [header].concat(filtered.map(row => Object.values(row).map(v => `"${v}"`).join(","))).join("\n");
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Laporan.csv'; a.click();
};

// UI & EVENTS
$('btnRefresh').onclick = refreshData;
$('btnClearFilter').onclick = () => { $('fFrom').value=''; $('fTo').value=''; renderTable(); };
$('fFrom').onchange = renderTable; $('fTo').onchange = renderTable;
$('btnAdd').onclick = () => { $('mEntry').classList.add('open'); resetEntryForm(); };
$('mEntryClose').onclick = () => { $('mEntry').classList.remove('open'); };
$('btnMaster').onclick = () => { $('mMaster').classList.add('open'); };
$('mMasterClose').onclick = () => { $('mMaster').classList.remove('open'); };
$('btnClear').onclick = async () => { if(confirm('HAPUS SEMUA DATA LAPORAN?')) { await client.from('logs').delete().neq('id','0'); refreshData(); } };

(function(){
    if(SUPABASE_URL.includes("https://ldipyeuhjimstjxgsnbu.supabase.co")) alert("eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaXB5ZXVoamltc3RqeGdzbmJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzQxMzQsImV4cCI6MjA4MDc1MDEzNH0.eKbaxoLw0-OBTBInJYb3LWLJhX4ujJFm_hYL8GVBekM");
    else refreshData();
})();
</script>
</body>
</html>
