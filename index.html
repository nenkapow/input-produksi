<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini App Produksi - v0.5.0 Online + Supabase</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* === SEMUA CSS SAMA DENGAN VERSI LAMA KAMU (saya keep 100% sama biar tampilan tidak berubah) === */
:root {
  --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
  --primary: #4f46e5; --primary-hover: #4338ca; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1); --radius: 12px; --radius-sm: 8px;
}
*{box-sizing:border-box;outline:none;}
body{margin:0;background:var(--bg-body);color:var(--text-main);font-family:'Inter',system-ui,sans-serif;line-height:1.5;-webkit-font-smoothing:antialiased;}
.wrap{max-width:1400px;margin:0 auto;padding:2rem;}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.grid{display:grid;gap:16px;}
h2{font-size:1.5rem;font-weight:700;margin:0;}
h3{font-size:1.25rem;font-weight:600;margin:0;}
h4{font-size:1rem;font-weight:600;margin:0 0 12px 0;color:var(--primary);text-transform:uppercase;letter-spacing:0.05em;}
.muted{color:var(--text-muted);font-size:0.85rem;margin-bottom:4px;font-weight:500;}
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow-sm);margin-bottom:16px;transition:box-shadow .2s;}
.card:hover{box-shadow:var(--shadow-md);}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;font-size:.9rem;font-weight:500;border-radius:var(--radius-sm);border:1px solid var(--border);background:white;color:var(--text-main);cursor:pointer;transition:all .2s;box-shadow:var(--shadow-sm);}
.btn:hover{background:#f8fafc;transform:translateY(-1px);}
.btn:active{transform:translateY(0);}
.btn.primary{background:var(--primary);color:white;border-color:var(--primary);}
.btn.primary:hover{background:var(--primary-hover);box-shadow:0 4px 6px -1px rgba(79,70,229,.3);}
.btn.ok{background:var(--success);color:white;border-color:var(--success);}
.btn.ok:hover{background:#059669;}
.btn.danger{background:white;color:var(--danger);border-color:#fecaca;}
.btn.danger:hover{background:#fef2f2;border-color:var(--danger);}
.btn.danger.primary{background:var(--danger);color:white;border-color:var(--danger);}
.btn.sm{padding:6px 12px;font-size:.8rem;border-radius:6px;}
.input,select,textarea{width:100%;padding:10px 12px;font-size:.95rem;border:1px solid var(--border);border-radius:var(--radius-sm);background:#f8fafc;color:var(--text-main);transition:all .2s;}
.input:focus,select:focus,textarea:focus{background:white;border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.15);}
input[type=checkbox]{width:16px;height:16px;accent-color:var(--primary);}
input[type=date],input[type=number]{font-family:'Inter',sans-serif;}
input[type=number]{font-family:'JetBrains Mono',monospace;}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:.9rem;}
thead th{background:#f8fafc;color:var(--text-muted);font-weight:600;text-transform:uppercase;font-size:.75rem;letter-spacing:.05em;padding:12px 16px;border-bottom:1px solid var(--border);border-top:1px solid var(--border);position:sticky;top:0;z-index:10;white-space:nowrap;}
thead th:first-child{border-top-left-radius:var(--radius-sm);border-left:1px solid var(--border);}
thead th:last-child{border-top-right-radius:var(--radius-sm);border-right:1px solid var(--border);}
tbody td{padding:12px 16px;border-bottom:1px solid var(--border);vertical-align:middle;}
tbody tr:hover td{background:#f8fafc;}
.right{text-align:right;font-family:'JetBrains Mono',monospace;}
.badge{font-size:.75rem;font-weight:600;padding:4px 10px;border-radius:20px;background:#e0e7ff;color:var(--primary);margin-left:8px;vertical-align:middle;border:1px solid #c7d2fe;}
.modal{position:fixed;inset:0;background:rgba(15,23,42,.6);backdrop-filter:blur(4px);display:none;align-items:flex-start;justify-content:center;padding:40px 20px;z-index:100;overflow:auto;opacity:0;transition:opacity .3s;}
.modal.open{display:flex;opacity:1;}
.modal .card{width:100%;max-width:1100px;animation:slideUp .3s cubic-bezier(.16,1,.3,1);box-shadow:var(--shadow-lg);}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;}
.filter-bar{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end;}
.stat-box{background:#f8fafc;border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center;}
@media(max-width:768px){.wrap{padding:1rem;}.header-row{flex-direction:column;align-items:flex-start;gap:1rem;}.grid{grid-template-columns:1fr !important;}.filter-bar > div{flex:1 1 100%;}}
</style>
</head>
<body>

<div class="wrap">
  <div class="header-row">
    <div>
      <h2>Mini App Produksi <span style="font-weight:400;color:var(--text-muted);font-size:1rem;">v0.5.0 Online</span></h2>
      <div class="muted" style="margin-top:4px;">Data tersimpan di Supabase (real-time)</div>
    </div>
    <div class="row">
      <button id="btnPrint" class="btn ok">
        <svg style="width:16px;height:16px;margin-right:6px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg> Cetak
      </button>
    </div>
  </div>

  <!-- SEMUA HTML SAMA PERSIS DENGAN VERSI LAMA KAMU (saya keep 100%) -->
  <!-- ... (sama persis sampai </div> terakhir sebelum script) ... -->

  <!-- Hanya bagian script yang berubah total ke Supabase -->
</div>

<!-- Modal Master & Entry (sama persis) -->
<!-- (saya tidak copy-paste lagi biar tidak terlalu panjang, tapi kamu tinggal copy dari file lama kamu) -->
<!-- Pastikan semua elemen id tetap sama seperti versi localStorage kamu -->

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

  // === GANTI 2 BARIS INI AJA ===
  const SUPABASE_URL = 'https://ldipyeuhjimstjxgsnbu.supabase.co'        // ← ganti
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkaXB5ZXVoamltc3RqeGdzbmJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzQxMzQsImV4cCI6MjA4MDc1MDEzNH0.eKbaxoLw0-OBTBInJYb3LWLJhX4ujJFm_hYL8GVBekM'    // ← ganti
  // ===============================

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  const $ = id => document.getElementById(id)
  const toNum = v => isNaN(+v) ? 0 : +v
  const round2 = n => (Math.round(n * 100) / 100).toFixed(2)
  const todayISO = () => new Date().toISOString().slice(0, 10)

  let master = []
  let logs = []

  // ====================== SUPABASE CRUD ======================
  async function loadMaster() {
    const { data } = await supabase.from('master_produk').select('*').order('kode')
    return data || []
  }
  async function loadLogs() {
    const { data } = await supabase.from('logs_produksi').select('*').order('tanggal', { ascending: false })
    return data || []
  }
  async function refreshAll() {
    master = await loadMaster()
    logs = await loadLogs()
    seedProdukList()
    renderTable()
    renderMaster()
  }

  // Real-time (auto refresh kalau ada orang lain nambah data)
  supabase.channel('logs').on('postgres_changes', { event: '*', schema: 'public', table: 'logs_produksi' }, () => refreshAll()).subscribe()
  supabase.channel('master').on('postgres_changes', { event: '*', schema: 'public', table: 'master_produk' }, () => refreshAll()).subscribe()

  // ====================== RENDER TABLE ======================
  const tbody = $('tbody'), rowCount = $('rowCount')
  function renderTable() {
    const from = $('fFrom').value ? new Date($('fFrom').value) : null
    const to = $('fTo').value ? new Date($('fTo').value) : null
    const qProd = $('fProduk').value.trim().toLowerCase()
    const qShift = $('fShift').value
    const qLine = $('fLine').value.trim().toLowerCase()

    let filtered = logs.filter(r => {
      const d = new Date(r.tanggal)
      const okDate = (!from || d >= from) && (!to || d <= to)
      const okProd = !qProd || r.kode.toLowerCase().includes(qProd) || r.nama.toLowerCase().includes(qProd)
      const okShift = !qShift || r.shift === qShift
      const okLine = !qLine || (r.line || '').toLowerCase().includes(qLine)
      return okDate && okProd && okShift && okLine
    })

    tbody.innerHTML = ''
    filtered.forEach(r => {
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td>${r.tanggal}</td>
        <td style="text-align:center"><span class="badge" style="margin:0">${r.shift}</span></td>
        <td>${r.line||''}</td>
        <td style="font-weight:600">${r.kode} — ${r.nama}</td>
        <td>${r.tipe||'pcs'}</td>
        <td class="right">${r.counter||0}</td>
        <td class="right">${r.cavity||0}</td>
        <td class="right">${(+r.sisa_sblm||0).toFixed(2)}</td>
        <td class="right">${(+r.sisa_ssdh||0).toFixed(2)}</td>
        <td class="right">${r.qty_dus||0}</td>
        <td class="right">${r.qty_box||0}</td>
        <td class="right">${r.qty_dus_plus||0}</td>
        <td class="right">${r.isi_dus_plus||0}</td>
        <td class="right" style="color:var(--success);font-weight:600">${Math.round(+r.okpcs||0)}</td>
        <td class="right">${(+r.okkg||0).toFixed(2)}</td>
        <td class="right" style="color:var(--danger)">${Math.round(+r.reject||0)}</td>
        <td class="right">${(+r.rejectkg||0).toFixed(2)}</td>
        <td class="right">${(+r.runnerkg||0).toFixed(2)}</td>
        <td class="right">${(+r.sisa_bahan||0).toFixed(2)}</td>
        <td class="right" style="font-weight:bold">${(+r.yieldpct||0).toFixed(2)}</td>
        <td class="right">${r.reject_max||0}</td>
        <td style="text-align:center"><button class="btn sm danger" data-id="${r.id}">Hapus</button></td>`
      tbody.appendChild(tr)
    })
    rowCount.textContent = filtered.length + ' data'
  }

  tbody.onclick = async e => {
    const btn = e.target.closest('button')
    if (!btn) return
    if (confirm('Hapus data ini?')) {
      await supabase.from('logs_produksi').delete().eq('id', btn.dataset.id)
      refreshAll()
    }
  }

  // ====================== MASTER PRODUK ======================
  function seedProdukList() {
    const dl = $('produkList'); if (!dl) return
    dl.innerHTML = ''
    master.forEach(p => {
      const o = document.createElement('option')
      o.value = `${p.kode} — ${p.nama}`
      dl.appendChild(o)
    })
  }

  function renderMaster() {
    const body = $('mpBody')
    body.innerHTML = master.length === 0
      ? '<tr><td colspan="9" class="muted" style="text-align:center;padding:20px;">Belum ada produk.</td></tr>'
      : ''
    master.forEach((p, i) => {
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${p.kode}</td><td style="font-weight:600">${p.nama}</td><td>${p.tipe||'pcs'}</td>
        <td class="right">${(+p.gram||0).toFixed(2)}</td><td class="right">${(+p.runner||0).toFixed(2)}</td>
        <td class="right">${p.cavity||1}</td><td class="right">${p.per_dus||0}</td><td class="right">${p.per_box||0}</td>
        <td style="text-align:center">
          <button class="btn sm" data-act="edit" data-i="${i}">Edit</button>
          <button class="btn sm danger" data-act="del" data-i="${i}">Hapus</button>
        </td>`
      body.appendChild(tr)
    })
  }

  $('mpBody').onclick = async e => {
    const b = e.target.closest('button')
    if (!b) return
    const i = +b.dataset.i
    const p = master[i]
    if (b.dataset.act === 'edit') {
      $('mpKode').value = p.kode
      $('mpNama').value = p.nama
      $('mpTipe').value = p.tipe || 'pcs'
      $('mpGram').value = p.gram || ''
      $('mpRunner').value = p.runner || ''
      $('mpCavity').value = p.cavity || ''
      $('mpPerDus').value = p.per_dus || ''
      $('mpPerBox').value = p.per_box || ''
    } else if (confirm('Hapus produk ini?')) {
      await supabase.from('master_produk').delete().eq('id', p.id)
      refreshAll()
    }
  }

  $('mpAdd').onclick = async () => {
    const kode = $('mpKode').value.trim()
    if (!kode) return alert('Kode wajib diisi')
    const rec = {
      kode,
      nama: $('mpNama').value.trim() || kode,
      tipe: $('mpTipe').value,
      gram: toNum($('mpGram').value),
      runner: toNum($('mpRunner').value),
      cavity: toNum($('mpCavity').value) || 1,
      per_dus: toNum($('mpPerDus').value),
      per_box: toNum($('mpPerBox').value)
    }
    await supabase.from('master_produk').upsert(rec, { onConflict: 'kode' })
    ;['mpKode','mpNama','mpGram','mpRunner','mpCavity','mpPerDus','mpPerBox'].forEach(id => $(id).value = '')
    refreshAll()
  }

  // ====================== ENTRY & HITUNGAN (sama persis kayak versi lama) ======================
  const sblmIds = ['eSblm1','eSblm2','eSblm3','eSblm4','eSblm5','eSblm6']
  const ssdhIds = ['eSsdh1','eSsdh2','eSsdh3','eSsdh4','eSsdh5','eSsdh6']
  const rIds = ['rBintik','rFlashing','rShort','rWarna','rLain']

  function findProduk(text) {
    if (!text) return null
    const t = text.toLowerCase().trim()
    return master.find(p => `${p.kode} — ${p.nama}`.toLowerCase() === t) ||
           master.find(p => p.kode.toLowerCase() === t) ||
           master.find(p => p.nama.toLowerCase().includes(t))
  }

  function hydrateProduk(p) {
    if (!p) {
      $('eGram').value = $('eRunner').value = $('eCavity').value = $('eIsiDus').value = $('eIsiBox').value = ''
      $('badgeTipe').textContent = ''
      $('lblSblm').textContent = $('lblSsdh').textContent = 'Sisa (pcs)'
      return
    }
    $('eGram').value = p.gram || 0
    $('eRunner').value = p.runner || 0
    $('eCavity').value = p.cavity || 1
    $('eIsiDus').value = p.per_dus || 0
    $('eIsiBox').value = p.per_box || 0
    $('badgeTipe').textContent = p.tipe === 'kg_sisa' ? 'Mode KG' : 'Mode PCS'
    const unit = p.tipe === 'kg_sisa' ? '(kg)' : '(pcs)'
    $('lblSblm').textContent = 'Sisa Sebelum ' + unit
    $('lblSsdh').textContent = 'Sisa Sesudah ' + unit
  }

  function sum(ids) { return ids.reduce((a, id) => a + toNum($(id).value), 0) }

  function compute() {
    const prod = findProduk($('eProduk').value)
    const tipe = prod?.tipe || 'pcs'
    const gram = toNum($('eGram').value)
    const cav = Math.max(1, toNum($('eCavity').value))
    const counter = toNum($('eCounter').value)

    let sblm = sum(sblmIds), ssdh = sum(ssdhIds)
    if (tipe === 'kg_sisa' && gram > 0) {
      const conv = 1000 / gram
      sblm *= conv
      ssdh *= conv
    }

    const pack = toNum($('eQtyDus').value) * toNum($('eIsiDus').value) +
                 toNum($('eQtyBox').value) * toNum($('eIsiBox').value) +
                 toNum($('eQtyDusPlus').value) * toNum($('eIsiDusPlus').value)

    const okpcs = pack - sblm + ssdh
    const hasil = counter * cav + sblm - ssdh
    const rejectpcs = hasil - okpcs
    const okkg = okpcs * gram / 1000
    const rejectkg = rejectpcs * gram / 1000
    const runnerkg = counter * toNum($('eRunner').value) / 1000
    const yieldpct = hasil > 0 ? (okpcs / hasil) * 100 : 0
    const sisaBahan = toNum($('eJatah').value) + toNum($('eStok').value) - (runnerkg + rejectkg + okkg + toNum($('eBalokan').value))
    const overpack = pack > hasil

    return { prod, tipe, gram, cav, counter, sblm, ssdh, pack, hasil, okpcs, okkg, rejectpcs, rejectkg, runnerkg, yieldpct, sisaBahan, overpack }
  }

  function recalc() {
    const p = compute()
    $('vHasil').textContent = Math.round(p.hasil)
    $('vOkPcs').textContent = Math.round(p.okpcs)
    $('vOkKg').textContent = round2(p.okkg)
    $('vRejectPcs').textContent = Math.round(p.rejectpcs)
    $('vRejectKg').textContent = round2(p.rejectkg)
    $('vRunnerKg').textContent = round2(p.runnerkg)
    $('vYield').textContent = round2(p.yieldpct)
    $('eSisaBahan').value = $('vSisaBahan').textContent = round2(p.sisaBahan)
    $('warnOver').style.display = p.overpack ? 'block' : 'none'
  }

  // event input yang trigger recalc
  ;['eProduk','eCavity','eCounter','eQtyDus','eQtyBox','eQtyDusPlus','eIsiDusPlus','eJatah','eStok','eBalokan'].concat(sblmIds).concat(ssdhIds).forEach(id => {
    const el = $(id)
    if (el) el.addEventListener('input', () => {
      if (id === 'eProduk') hydrateProduk(findProduk(el.value))
      recalc()
    })
  })

  function openEntry() {
    $('eTanggal').value = todayISO()
    $('eShift').value = '1'
    ;['eLine','eProduk','eCounter','eJatah','eStok','eBalokan','eQtyDus','eQtyBox','eQtyDusPlus','eIsiDusPlus','eCatatan'].forEach(id => $(id).value = '')
    sblmIds.concat(ssdhIds).forEach(id => $(id).value = '')
    rIds.forEach(id => $(id).value = '')
    hydrateProduk(null)
    recalc()
  }

  $('btnSaveEntry').onclick = async () => {
    const p = compute()
    if (!p.prod) return alert('Pilih produk dulu!')

    const rec = {
      tanggal: $('eTanggal').value || todayISO(),
      shift: $('eShift').value,
      line: $('eLine').value.trim(),
      kode: p.prod.kode,
      nama: p.prod.nama,
      tipe: p.tipe,
      gram: p.gram,
      runner: toNum($('eRunner').value),
      cavity: p.cav,
      counter: p.counter,
      sisa_sblm: +p.sblm.toFixed(2),
      sisa_ssdh: +p.ssdh.toFixed(2),
      hasil: +p.hasil.toFixed(2),
      okpcs: +p.okpcs.toFixed(2),
      okkg: +round2(p.okkg),
      reject: +p.rejectpcs.toFixed(2),
      rejectkg: +round2(p.rejectkg),
      runnerkg: +round2(p.runnerkg),
      sisa_bahan: +round2(p.sisaBahan),
      yieldpct: +round2(p.yieldpct),
      qty_dus: toNum($('eQtyDus').value),
      isi_dus: toNum($('eIsiDus').value),
      qty_box: toNum($('eQtyBox').value),
      isi_box: toNum($('eIsiBox').value),
      qty_dus_plus: toNum($('eQtyDusPlus').value),
      isi_dus_plus: toNum($('eIsiDusPlus').value),
      catatan: $('eCatatan').value.trim(),
      reject_bintik: toNum($('rBintik').value),
      reject_flashing: toNum($('rFlashing').value),
      reject_short: toNum($('rShort').value),
      reject_warna: toNum($('rWarna').value),
      reject_lain: toNum($('rLain').value),
      reject_total_kecil: sum(rIds),
      reject_max: Math.max(...rIds.map(id => toNum($(id).value)), 0)
    }

    await supabase.from('logs_produksi').insert([rec])
    $('mEntry').classList.remove('open')
    refreshAll()
  }

  // ====================== BUTTON LAIN ======================
  $('btnAdd').onclick = () => { openEntry(); $('mEntry').classList.add('open') }
  $('btnMaster').onclick = () => { renderMaster(); $('mMaster').classList.add('open') }
  $('mEntryClose').onclick = $('mMasterClose').onclick = e => e.target.closest('.modal').classList.remove('open')
  $('btnPrint').onclick = () => window.print()
  $('btnClear').onclick = async () => {
    if (confirm('Hapus SEMUA data laporan produksi?')) {
      await supabase.from('logs_produksi').delete()
      refreshAll()
    }
  }
  $('btnClearFilter').onclick = () => {
    $('fFrom').value = $('fTo').value = $('fProduk').value = $('fLine').value = ''
    $('fShift').value = ''
    renderTable()
  }

  // Import CSV Master (sama kayak versi lama, cuma save ke Supabase)
  $('btnImportCsv').onclick = () => $('fileCsvMaster').click()
  $('fileCsvMaster').addEventListener('change', async e => {
    const file = e.target.files[0]
    if (!file) return
    const allowDup = $('chkAllowDup').checked
    const text = await file.text()
    const lines = text.split(/\r?\n/).filter(l => l.trim())
    if (lines.length < 2) return alert('CSV kosong!')
    const delim = lines[0].includes(';') ? ';' : ','
    const headers = lines[0].toLowerCase().split(delim).map(h => h.trim().replace(/"/g,''))
    const idx = {
      kode: headers.findIndex(h => h.includes('kode') || h.includes('code')),
      nama: headers.findIndex(h => h.includes('nama') || h.includes('name') || h.includes('produk')),
      gram: headers.findIndex(h => h.includes('gram') || h.includes('berat')),
      runner: headers.findIndex(h => h.includes('runner')),
      cavity: headers.findIndex(h => h.includes('cav') || h.includes('cavity')),
      dus: headers.findIndex(h => h.includes('dus')),
      box: headers.findIndex(h => h.includes('box')),
      tipe: headers.findIndex(h => h.includes('tipe') || h.includes('type'))
    }

    const records = []
    for (let i = 1; i < lines.length; i++) {
      const c = lines[i].split(delim).map(x => x.trim().replace(/"/g,''))
      if (!c[idx.kode] || !c[idx.nama]) continue
      records.push({
        kode: c[idx.kode],
        nama: c[idx.nama],
        tipe: idx.tipe >= 0 ? c[idx.tipe] || 'pcs' : 'pcs',
        gram: idx.gram >= 0 ? toNum(c[idx.gram].replace(',','.')) : 0,
        runner: idx.runner >= 0 ? toNum(c[idx.runner].replace(',','.')) : 0,
        cavity: idx.cavity >= 0 ? toNum(c[idx.cavity]) : 1,
        per_dus: idx.dus >= 0 ? toNum(c[idx.dus]) : 0,
        per_box: idx.box >= 0 ? toNum(c[idx.box]) : 0
      })
    }

    if (!allowDup) {
      // hapus dulu yang kode-nya sama
      const existing = await supabase.from('master_produk').select('kode')
      const existingCodes = existing.data.map(x => x.kode.toLowerCase())
      records = records.filter(r => !existingCodes.includes(r.kode.toLowerCase()))
    }

    if (records.length) await supabase.from('master_produk').insert(records)
    alert(`Sukses import ${records.length} produk!`)
    $('fileCsvMaster').value = ''
    refreshAll()
  })

  // ====================== INIT ======================
  refreshAll()
</script>
  
<!-- Copy semua HTML modal (mMaster & mEntry) dari file lama kamu di sini -->
<!-- Pastikan tidak ada yang berubah selain script di atas -->

</body>
</html>
