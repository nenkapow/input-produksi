<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#022c22">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>Absen Produksi (Berkah Edition)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* === TEMA ISLAMI (EMERALD & GOLD) === */
      --bg-body: #022c22;
      --bg-card: #064e3b;
      --bg-input: #065f46;
      --text-main: #ecfdf5;
      --text-muted: #a7f3d0;
      --gold: #d4af37;
      --gold-hover: #b4942b;
      --success: #10b981;
      --warn: #fbbf24;
      --danger: #ef4444;
      --border: #d4af37;
      --radius: 12px;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    
    body { 
      margin: 0; background-color: var(--bg-body);
      background-image: radial-gradient(circle at 2px 2px, rgba(212, 175, 55, 0.15) 1px, transparent 0);
      background-size: 30px 30px;
      color: var(--text-main); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 14px; line-height: 1.5; 
    }
    
    .wrap { max-width:1200px; margin:0 auto; padding:20px; }

    /* HEADER */
    .bismillah {
      font-family: 'Amiri', serif; font-size: 2.2rem; color: var(--gold);
      text-align: center; margin-bottom: 0.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    .slogan {
      text-align: center; font-size: 0.9rem; color: var(--text-muted);
      font-style: italic; margin-bottom: 2rem;
    }
    
    .header-card {
      background: var(--bg-card); border: 1px solid var(--gold); border-radius: var(--radius);
      padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
    }
    
    .controls { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:16px; align-items:end; }
    .form-group { display:flex; flex-direction:column; gap:6px; }
    .form-group label { font-size:12px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
    
    input, select {
      background: var(--bg-input); border: 1px solid #374151; color: var(--text-main);
      padding: 10px 12px; border-radius: 8px; font-size: 14px; width: 100%; outline: none; transition: border-color 0.2s;
    }
    input:focus, select:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }

    /* TABS */
    .tabs { background: var(--bg-input); padding: 4px; border-radius: 10px; border: 1px solid #374151; display: flex; }
    .tab {
      flex: 1; border: none; background: transparent; color: var(--text-muted);
      padding: 8px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .tab.active { background: var(--gold); color: #022c22; box-shadow: 0 2px 4px rgba(0,0,0,0.2); font-weight: 800; }

    /* INFO BAR */
    .info-bar { margin-top: 16px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(212, 175, 55, 0.3); padding-top: 16px; flex-wrap: wrap; gap: 10px; }
    .badge { background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; border: 1px solid var(--success); }
    .shortcuts { font-size: 12px; color: var(--text-muted); display: flex; gap: 12px; }
    .shortcuts b { color: var(--gold); background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }

    /* GRID TABLE */
    .grid-card {
      background: var(--bg-card); border: 1px solid var(--gold); border-radius: var(--radius);
      overflow: hidden; box-shadow: var(--shadow);
    }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    
    th {
      background: #022c22; color: var(--gold); font-weight: 700; font-size: 12px;
      text-transform: uppercase; text-align: left; padding: 14px 16px; border-bottom: 2px solid var(--gold);
    }
    td { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: rgba(212, 175, 55, 0.05); }

    input.cell {
      background: rgba(0,0,0,0.2); border: 1px solid transparent; text-align: center;
      font-weight: 700; color: var(--gold); width: 100%; max-width: 80px;
    }
    input.cell:focus { border-color: var(--gold); background: var(--bg-input); color: var(--text-main); }
    
    .process-name { font-weight: 600; color: var(--text-main); }
    .total-cell { font-weight: 800; color: var(--success); text-align: center; font-size: 1.1em; }

    tfoot tr { background: #022c22; font-weight: 700; }
    tfoot td { color: var(--gold); text-align: center; padding: 16px; font-size: 15px; border-top: 2px solid var(--gold); }
    tfoot td:first-child { text-align: right; color: var(--text-muted); }

    /* ACTIONS */
    .actions {
      padding: 16px; background: #022c22; border-top: 1px solid var(--gold);
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      background: var(--bg-input); border: 1px solid var(--gold); color: var(--text-main);
      padding: 10px 16px; border-radius: 50px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; font-size: 13px;
    }
    .btn:hover { background: var(--gold); color: #022c22; transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(to bottom, #d4af37, #b4942b); border: none; color: #022c22; box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3); }
    .btn.success { border-color: var(--success); color: var(--success); background: transparent; }
    .btn.success:hover { background: var(--success); color: #022c22; }
    .btn.warn { border-color: var(--warn); color: var(--warn); background: transparent; }
    .btn.warn:hover { background: var(--warn); color: #451a03; }

    /* REKAP & FILTERS */
    #rekapWrap { margin-top: 30px; border-color: var(--warn); box-shadow: 0 0 20px rgba(251, 191, 36, 0.1); }
    
    .rekap-header {
      background: #022c22; padding: 16px;
      border-bottom: 1px solid var(--warn);
    }
    
    .rekap-title-row {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;
    }
    .rekap-title-row h3 { margin: 0; color: var(--warn); font-size: 1.1rem; }
    .machine-count { font-size: 0.9rem; color: var(--text-muted); font-weight: normal; }
    .machine-count b { color: var(--text-main); font-size: 1.1rem; }

    /* FILTER BUTTONS */
    .filter-bar { display: flex; gap: 8px; }
    .filter-btn {
        flex: 1; border: 1px solid var(--border); background: rgba(0,0,0,0.3); color: var(--text-muted);
        padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;
        transition: 0.2s;
    }
    .filter-btn:hover { background: rgba(212, 175, 55, 0.1); color: var(--gold); }
    .filter-btn.active { background: var(--gold); color: #022c22; border-color: var(--gold); font-weight: 800; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

    /* TOAST */
    #updateToast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border: 1px solid var(--gold); padding: 12px 20px;
      border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      display: none; align-items: center; gap: 12px; z-index: 999; color: var(--gold);
    }
    #btnReload { background: var(--gold); border: none; color: #022c22; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 700; }

    @media (max-width: 600px) {
      .wrap { padding: 12px; }
      .header-card, .grid-card { padding: 0; border-radius: 0; border-left: 0; border-right: 0; }
      .header-card { padding: 16px; border-radius: 12px; border: 1px solid var(--gold); }
      .shortcuts { display: none; }
      th, td { padding: 10px; font-size: 13px; }
      .rekap-title-row { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="bismillah">بسم الله الرحمن الرحيم</div>
  <div class="slogan">"Insya Allah Memudahkan Pekerjaan & Rezeki Lancar"</div>

  <div class="header-card">
    <div class="controls">
      <div class="form-group">
        <label>Tanggal Produksi</label>
        <input type="date" id="tgl">
      </div>
      <div class="form-group">
        <label>Shift Kerja</label>
        <select id="shift">
          <option value="1">Shift 1 (Pagi)</option>
          <option value="2">Shift 2 (Siang)</option>
          <option value="3">Shift 3 (Malam)</option>
        </select>
      </div>
      <div class="form-group" style="flex:1.5">
        <label>Work Center</label>
        <div class="tabs">
          <button class="tab active" data-center="Injection">Injection</button>
          <button class="tab" data-center="Assembly">Assembly</button>
        </div>
      </div>
    </div>
    
    <div class="info-bar">
      <span class="badge" id="keyPreview">Loading...</span>
      <div class="shortcuts">
        <span><b>Ctrl+S</b> Simpan</span>
        <span><b>Ctrl+E</b> Export JSON</span>
      </div>
    </div>
  </div>

  <div class="grid-card">
    <div class="table-wrap">
      <table id="grid">
        <thead>
          <tr>
            <th style="width:50px; text-align:center;">#</th>
            <th>Proses / Bagian</th>
            <th style="text-align:center; width:100px;">Tetap</th>
            <th style="text-align:center; width:100px;">Kontrak</th>
            <th style="text-align:center; width:100px;">Yayasan</th>
            <th style="text-align:center; width:80px;">Total</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td></td>
            <td style="text-align:right;">TOTAL SHIFT INI</td>
            <td id="totTetap">0</td>
            <td id="totKontrak">0</td>
            <td id="totYayasan">0</td>
            <td id="totAll" style="color:var(--success); font-weight:800;">0</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="actions">
      <button class="btn success" id="btnSave">
        Simpan Data
      </button>
      <div style="flex:1"></div>
      <button class="btn" id="btnExportJSON">JSON</button>
      <button class="btn" id="btnExportCSV">CSV</button>
      <button class="btn warn" id="btnRekap">Lihat Rekap Harian</button>
    </div>
  </div>

  <div class="grid-card" id="rekapWrap" style="display:none;">
    <div class="rekap-header">
      <div class="rekap-title-row">
          <h3>REKAPITULASI HARIAN</h3>
          <span class="machine-count" id="machineCount">Total Mesin Aktif: <b>0 Unit</b></span>
      </div>
      
      <div class="filter-bar">
          <button class="filter-btn active" onclick="filterRekap('all', this)">SEMUA SHIFT</button>
          <button class="filter-btn" onclick="filterRekap(1, this)">SHIFT 1</button>
          <button class="filter-btn" onclick="filterRekap(2, this)">SHIFT 2</button>
          <button class="filter-btn" onclick="filterRekap(3, this)">SHIFT 3</button>
      </div>
    </div>
    
    <div class="table-wrap">
      <table id="rekapTable">
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>Proses</th>
            <th style="text-align:center;">Tetap</th>
            <th style="text-align:center;">Kontrak</th>
            <th style="text-align:center;">Yayasan</th>
            <th style="text-align:center;">Total</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td></td>
            <td style="text-align:right;">TOTAL (FILTERED)</td>
            <td id="rTotTetap">0</td>
            <td id="rTotKontrak">0</td>
            <td id="rTotYayasan">0</td>
            <td id="rTotTotal">0</td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <div class="actions">
      <span style="font-size:12px; color:var(--text-muted);" id="rekapTitle"></span>
      <div style="flex:1"></div>
      <button class="btn" id="btnRekapCSV">Download Rekap CSV</button>
      <button class="btn" onclick="document.getElementById('rekapWrap').style.display='none'">Tutup</button>
    </div>
  </div>
</div>

<div id="updateToast">
  <span>Update baru tersedia!</span>
  <button id="btnReload">Refresh</button>
</div>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  window.APP_VERSION = '2025-12-05-FIX';

  const SUPABASE_URL  = 'https://xpcmrdkdnbqdohjjqxds.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwY21yZGtkbmJxZG9oampxeGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5Mzc2ODAsImV4cCI6MjA3ODUxMzY4MH0.ZLEzHKaWjic5vn_zAiD6S2jZgU-s2E-Z8Kbd4M66zE8';
  const supa = createClient(SUPABASE_URL, SUPABASE_ANON);

  const $tgl   = document.getElementById('tgl');
  const $shift = document.getElementById('shift');
  const $tabs  = document.querySelectorAll('.tab');
  const $key   = document.getElementById('keyPreview');
  const $gridBody = document.querySelector('#grid tbody');

  let CENTER = 'Injection';
  let PROC = [];
  let ROWS = [];
  
  // GLOBAL STORAGE UNTUK REKAP FILTER
  let _allDailyData = []; 

  const params = new URLSearchParams(location.search);
  const getTodayLocalISO = () => {
    const d = new Date();
    const tzOffset = d.getTimezoneOffset() * 60000;
    return new Date(Date.now() - tzOffset).toISOString().slice(0,10);
  };
  const todayISO = getTodayLocalISO();
  $tgl.value = params.get('today') === '1' ? todayISO : (params.get('date') || todayISO);

  $tabs.forEach(b=>b.addEventListener('click', ()=>{
    $tabs.forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    CENTER = b.dataset.center;
    refresh();
  }));
  $tgl.addEventListener('change', refresh);
  $shift.addEventListener('change', refresh);

  document.getElementById('btnSave').onclick        = saveToServer;
  document.getElementById('btnExportJSON').onclick  = ()=>downloadJSON(currentPayload(),'shift.json');
  document.getElementById('btnExportCSV').onclick   = ()=>downloadCSV(rowsToCSV(ROWS),'shift.csv');
  document.getElementById('btnRekap').onclick       = fetchAndShowRekap;
  document.getElementById('btnRekapCSV').onclick    = ()=>{
    const csv = rekapToCSV(_lastRekapRendered.rows, _lastRekapRendered.totals);
    downloadCSV(csv,'rekap_filtered.csv');
  };

  // HOTKEYS
  window.addEventListener('keydown', e=>{
    if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); saveToServer(); }
    if(e.ctrlKey && e.key.toLowerCase()==='e'){ e.preventDefault(); downloadJSON(currentPayload(),'shift.json'); }
  });

  async function fetchProcesses(center){
    try {
      const { data, error } = await supa.from('processes').select('id,name,sort').eq('center', center).order('sort', { ascending:true });
      if(error) throw error; return data;
    } catch(e) {
      console.error(e);
      $key.textContent = "Error koneksi";
      return [];
    }
  }

  async function fetchAttendance(dateISO, shift, center){
    try {
      const { data, error } = await supa.from('attendance').select('process_id,tetap,kontrak,yayasan,processes(name,sort)').eq('work_date', dateISO).eq('shift', shift).eq('center', center).order('processes(sort)');
      if(error) throw error;
      return data.map(r=>({
        process_id: r.process_id, name: r.processes.name, tetap: r.tetap, kontrak: r.kontrak, yayasan: r.yayasan,
        total: (r.tetap||0)+(r.kontrak||0)+(r.yayasan||0)
      }));
    } catch(e) { return []; }
  }

  async function upsertAttendance(dateISO, shift, center, rows){
    const payload = rows.map(r=>({
      work_date: dateISO, shift: Number(shift), center, process_id: r.process_id,
      tetap: Number(r.tetap||0), kontrak: Number(r.kontrak||0), yayasan: Number(r.yayasan||0)
    }));
    const { error } = await supa.from('attendance').upsert(payload, { onConflict:'work_date,shift,center,process_id' });
    if(error) throw error;
  }

  async function refresh(){
    $key.textContent = "Loading...";
    PROC = await fetchProcesses(CENTER);
    ROWS = PROC.map(p=>({process_id:p.id,name:p.name,tetap:null,kontrak:null,yayasan:null,total:0}));
    
    if(PROC.length > 0) {
      const serverRows = await fetchAttendance($tgl.value, $shift.value, CENTER);
      const byPid = Object.fromEntries(serverRows.map(r=>[r.process_id, r]));
      ROWS = ROWS.map(r => byPid[r.process_id] ? byPid[r.process_id] : r);
      renderGrid();
      $key.textContent = `${$tgl.value} • Shift ${$shift.value} • ${CENTER}`;
    } else {
       $gridBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Gagal memuat data / Data kosong</td></tr>';
    }
    document.getElementById('rekapWrap').style.display='none';
  }

  function renderGrid() {
    $gridBody.innerHTML = '';
    ROWS.forEach((r, idx) => {
      const val = k => (r[k] ? r[k] : '');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:center; color:var(--text-muted);">${idx + 1}</td>
        <td class="process-name">${escapeHTML(r.name)}</td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="tetap" value="${val('tetap')}" placeholder="-"></td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="kontrak" value="${val('kontrak')}" placeholder="-"></td>
        <td style="text-align:center;"><input type="number" class="cell" data-i="${idx}" data-k="yayasan" value="${val('yayasan')}" placeholder="-"></td>
        <td class="total-cell" id="t${idx}">${Number(r.tetap||0)+Number(r.kontrak||0)+Number(r.yayasan||0)}</td>
      `;
      $gridBody.appendChild(tr);
    });
    
    $gridBody.querySelectorAll('input.cell').forEach(inp => {
      inp.addEventListener('input', () => {
        const i = Number(inp.dataset.i);
        const k = inp.dataset.k;
        ROWS[i][k] = inp.value === '' ? null : Number(inp.value);
        ROWS[i].total = Number(ROWS[i].tetap||0) + Number(ROWS[i].kontrak||0) + Number(ROWS[i].yayasan||0);
        document.getElementById('t' + i).textContent = ROWS[i].total;
        updateTotals();
      });
    });
    updateTotals();
  }

  async function saveToServer(){
    const btn = document.getElementById('btnSave');
    const oldText = btn.innerHTML;
    btn.innerHTML = 'Menyimpan...';
    try{
      await upsertAttendance($tgl.value, $shift.value, CENTER, ROWS);
      toast('Alhamdulillah Data Tersimpan! ✅');
    }catch(e){
      console.error(e);
      alert('Gagal menyimpan ke server');
    }finally{
      btn.innerHTML = oldText;
    }
  }

  function updateTotals() {
    let tTetap=0, tKon=0, tYay=0, tAll=0;
    ROWS.forEach(r => {
      tTetap += Number(r.tetap||0); tKon += Number(r.kontrak||0);
      tYay += Number(r.yayasan||0); tAll += Number(r.total||0);
    });
    document.getElementById('totTetap').textContent = tTetap;
    document.getElementById('totKontrak').textContent = tKon;
    document.getElementById('totYayasan').textContent = tYay;
    document.getElementById('totAll').textContent = tAll;
  }

  // --- REKAPITULASI LOGIC BARU (FILTERABLE) ---
  
  async function fetchAndShowRekap() {
      const date = $tgl.value;
      const center = CENTER;
      
      // Ambil data mentah (SEMUA SHIFT) dari attendance table langsung
      // Biar bisa difilter di sisi client (browser)
      const { data, error } = await supa
          .from('attendance')
          .select('shift, tetap, kontrak, yayasan, processes(name, sort)')
          .eq('work_date', date)
          .eq('center', center)
          .order('processes(sort)', {ascending: true});
          
      if(error) return alert("Gagal ambil data rekap: " + error.message);
      
      // Simpan di global var buat filtering
      _allDailyData = data || [];
      
      // Reset Tombol Filter jadi 'ALL'
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.filter-btn').classList.add('active'); // Tombol pertama (ALL)
      
      // Render Default (Semua)
      renderRekapTable('all');
      
      document.getElementById('rekapTitle').textContent = `Data: ${date} • ${center}`;
      document.getElementById('rekapWrap').style.display='block';
      document.getElementById('rekapWrap').scrollIntoView({behavior:'smooth'});
  }

  // Fungsi Global agar bisa dipanggil onclick
  window.filterRekap = function(mode, btn) {
      // Highlight tombol
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      renderRekapTable(mode);
  }

  let _lastRekapRendered = null;

  function renderRekapTable(mode) {
      // 1. FILTERING DATA
      let filteredData = [];
      if(mode === 'all') {
          filteredData = _allDailyData;
      } else {
          filteredData = _allDailyData.filter(r => r.shift == mode);
      }
      
      // 2. GROUPING & SUMMING (By Process Name)
      // Karena data raw, satu proses bisa muncul 3 kali (shift 1,2,3). Harus digabung.
      let grouped = {};
      
      filteredData.forEach(r => {
          const pName = r.processes?.name || 'Unknown';
          if(!grouped[pName]) {
              grouped[pName] = { name: pName, tetap:0, kontrak:0, yayasan:0, total:0, count:0 };
          }
          const t = (r.tetap||0);
          const k = (r.kontrak||0);
          const y = (r.yayasan||0);
          
          grouped[pName].tetap += t;
          grouped[pName].kontrak += k;
          grouped[pName].yayasan += y;
          grouped[pName].total += (t + k + y);
          grouped[pName].count += 1; // Menandakan mesin ini aktif di shift tsb
      });
      
      // Convert to Array & Sort (Sebenernya udah urut dari DB, tapi amanin aja)
      // Kita pakai urutan kemunculan pertama dari _allDailyData biar sort-nya bener
      // (Simplified: Kita percaya urutan DB aja, Object.values biasanya ngacak tapi ok lah)
      let rows = Object.values(grouped);
      
      // 3. RENDER TABLE
      const tbody = document.querySelector('#rekapTable tbody');
      tbody.innerHTML = '';
      
      let gtTet=0, gtKon=0, gtYay=0, gtAll=0;
      let activeMachines = 0;
      
      rows.forEach((r, i) => {
          // Hitung Grand Total Bawah
          gtTet += r.tetap;
          gtKon += r.kontrak;
          gtYay += r.yayasan;
          gtAll += r.total;
          
          // Hitung Mesin Aktif (Kalau ada isinya > 0, dianggap aktif)
          if(r.total > 0) activeMachines++;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="text-align:center;">${i+1}</td>
            <td>${escapeHTML(r.name)}</td>
            <td style="text-align:center;">${r.tetap}</td>
            <td style="text-align:center;">${r.kontrak}</td>
            <td style="text-align:center;">${r.yayasan}</td>
            <td style="text-align:center; font-weight:700;">${r.total}</td>`;
          tbody.appendChild(tr);
      });
      
      // Update Footer
      document.getElementById('rTotTetap').textContent = gtTet;
      document.getElementById('rTotKontrak').textContent = gtKon;
      document.getElementById('rTotYayasan').textContent = gtYay;
      document.getElementById('rTotTotal').textContent = gtAll;
      
      // Update Total Mesin di Header
      document.querySelector('#machineCount b').innerText = activeMachines + " Unit";
      
      // Simpan buat export CSV
      _lastRekapRendered = { rows, totals: { tetap:gtTet, kontrak:gtKon, yayasan:gtYay, total:gtAll } };
  }

  function currentPayload(){
    return { work_date:$tgl.value, shift:$shift.value, center:CENTER, rows: ROWS.map(({process_id,name,tetap,kontrak,yayasan,total})=>({process_id,name,tetap,kontrak,yayasan,total})) };
  }
  function rowsToCSV(rows){
    const lines = [['No','Proses','Tetap','Kontrak','Yayasan','Total'].join(',')];
    rows.forEach((r,i)=>lines.push([i+1, csv(r.name), Number(r.tetap||0), Number(r.kontrak||0), Number(r.yayasan||0), Number(r.total||0)].join(',')));
    return lines.join('\n');
  }
  function rekapToCSV(rows,tot){
    const lines = [['No','Proses','Tetap','Kontrak','Yayasan','Total'].join(',')];
    rows.forEach((r,i)=>lines.push([i+1, csv(r.name), r.tetap, r.kontrak, r.yayasan, r.total].join(',')));
    lines.push([ '', 'TOTAL', tot.tetap, tot.kontrak, tot.yayasan, tot.total ].join(','));
    return lines.join('\n');
  }
  function downloadCSV(csv, name){
    const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv], {type:'text/csv'})),download:name});
    a.click();
  }
  function downloadJSON(obj,name){
    const a = Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)], {type:'application/json'})),download:name});
    a.click();
  }
  
  const escmap = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#47;'};
  const escapeHTML = s => String(s).replace(/[&<>"'/]/g,m=>escmap[m]);
  const csv = s => `"${String(s).replace(/"/g,'""')}"`;
  
  function toast(msg){
    const div = document.createElement('div');
    Object.assign(div.style,{ position:'fixed',bottom:'30px',left:'50%',transform:'translateX(-50%)', background:'#10b981', padding:'10px 20px', borderRadius:'30px', color:'#064e3b', fontWeight:'600', zIndex:9999, boxShadow:'0 5px 15px rgba(0,0,0,0.3)' });
    div.textContent = msg; document.body.appendChild(div);
    setTimeout(()=>div.remove(),2000);
  }

  refresh();
</script>

<script type="module" src="sw-register.js"></script>
</body>
</html>
